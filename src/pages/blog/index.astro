---
import { getPublishedPosts, calculateReadingTime } from '@/utils/blog';
import BaseLayout from '@layouts/BaseLayout.astro';
import BlogCard from '@components/BlogCard.astro';

const posts = await getPublishedPosts();

const postsWithMeta = posts.map((post) => ({
  ...post,
  readingTime: calculateReadingTime(post.body || ''),
}));

const postsByYear = postsWithMeta.reduce(
  (acc, post) => {
    const year = post.data.pubDate.getFullYear();
    if (!acc[year]) {
      acc[year] = [];
    }
    acc[year].push(post);
    return acc;
  },
  {} as Record<number, typeof postsWithMeta>
);

const years = Object.keys(postsByYear).sort((a, b) => Number(b) - Number(a));
---

<BaseLayout
  title="Blog - Ratko Simidzija"
  description="Thoughts, learnings, and explorations in software engineering"
>
  <h1 class="page-title">Blog</h1>

  {
    years.length > 0 ? (
      <div class="posts-by-year">
        {years.map((year) => (
          <section class="year-section">
            <div class="year-heading">{year}</div>
            <div class="posts">
              {postsByYear[Number(year)].map((post) => (
                <BlogCard
                  title={post.data.title}
                  description={post.data.description}
                  pubDate={post.data.pubDate}
                  slug={post.id}
                  readingTime={post.readingTime}
                  tags={post.data.tags}
                  image={post.data.image}
                />
              ))}
            </div>
          </section>
        ))}
      </div>
    ) : (
      <p class="no-posts">No posts yet. Check back soon!</p>
    )
  }
</BaseLayout>

<style>
  .page-title {
    font-weight: 600;
    margin-bottom: var(--space-lg);
    color: var(--color-text);
    font-size: var(--font-size-xl);
  }

  .posts-by-year {
    margin-bottom: var(--space-2xl);
  }

  .year-section {
    margin-bottom: var(--space-lg);
  }

  .year-heading {
    margin-bottom: var(--space-md);
    color: var(--color-link);
    font-size: var(--font-size-lg);
    font-weight: 600;
  }

  .posts {
    display: flex;
    flex-direction: column;
    gap: var(--space-md);
  }

  .no-posts {
    color: var(--color-text-muted);
    text-align: center;
    padding: var(--space-2xl) 0;
  }
</style>
