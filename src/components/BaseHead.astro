---
interface Props {
  title: string;
  description: string;
  image?: string;
  publishedTime?: string;
  modifiedTime?: string;
  type?: 'website' | 'article';
}

const canonicalURL = new URL(Astro.url.pathname, Astro.site);

const { title, description, image, publishedTime, modifiedTime, type = 'website' } = Astro.props;

const defaultOgImage = new URL('/sr-logo-1200x630.png', Astro.site);
const ogImage = image ? new URL(image, Astro.site) : defaultOgImage;
---

<!-- Global Metadata -->
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />

<!-- Favicons -->
<link rel="icon" type="image/x-icon" href="/favicon.ico" />
<link rel="icon" type="image/svg+xml" href="/favicon.svg" />
<link rel="icon" type="image/png" sizes="96x96" href="/favicon-96x96.png" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png" />
<meta name="apple-mobile-web-app-title" content="Ratko Simidzija" />
<link rel="manifest" href="/site.webmanifest" />

<meta name="generator" content={Astro.generator} />

<!-- Canonical URL -->
<link rel="canonical" href={canonicalURL} />

<!-- Primary Meta Tags -->
<title>{title}</title>
<meta name="title" content={title} />
<meta name="description" content={description} />

<!-- Open Graph / Facebook -->
<meta property="og:type" content={type} />
<meta property="og:url" content={canonicalURL} />
<meta property="og:title" content={title} />
<meta property="og:description" content={description} />
<meta property="og:image" content={ogImage} />
<meta property="og:image:width" content="1200" />
<meta property="og:image:height" content="630" />
<meta property="og:site_name" content="Ratko Simidzija" />

{publishedTime && <meta property="article:published_time" content={publishedTime} />}
{modifiedTime && <meta property="article:modified_time" content={modifiedTime} />}

<!-- Twitter -->
<meta property="twitter:card" content="summary_large_image" />
<meta property="twitter:url" content={canonicalURL} />
<meta property="twitter:title" content={title} />
<meta property="twitter:description" content={description} />
<meta property="twitter:image" content={ogImage} />
<meta name="twitter:creator" content="@sixra01" />
<meta name="twitter:site" content="@sixra01" />

<!-- RSS Feed -->
<link rel="alternate" type="application/rss+xml" title="Ratko Simidzija" href="/rss.xml" />

<!-- Sitemap -->
<link rel="sitemap" href="/sitemap-index.xml" />

<!-- JSON-LD Structured Data -->
{
  type === 'article' && publishedTime && (
    <>
      <script
        is:inline
        type="application/ld+json"
        set:html={JSON.stringify({
          '@context': 'https://schema.org',
          '@type': 'BlogPosting',
          headline: title,
          description: description,
          datePublished: publishedTime,
          dateModified: modifiedTime || publishedTime,
          author: {
            '@type': 'Person',
            name: 'Ratko Simidzija',
            url: Astro.site?.toString(),
          },
          publisher: {
            '@type': 'Person',
            name: 'Ratko Simidzija',
          },
          mainEntityOfPage: {
            '@type': 'WebPage',
            '@id': canonicalURL.toString(),
          },
        })}
      />
      <script
        is:inline
        type="application/ld+json"
        set:html={JSON.stringify({
          '@context': 'https://schema.org',
          '@type': 'BreadcrumbList',
          itemListElement: [
            {
              '@type': 'ListItem',
              position: 1,
              name: 'Home',
              item: Astro.site?.toString(),
            },
            {
              '@type': 'ListItem',
              position: 2,
              name: 'Blog',
              item: new URL('/blog', Astro.site).toString(),
            },
            {
              '@type': 'ListItem',
              position: 3,
              name: title,
              item: canonicalURL.toString(),
            },
          ],
        })}
      />
    </>
  )
}

{
  Astro.url.pathname !== '/404/' &&
    Astro.url.pathname !== '/404' &&
    Astro.url.pathname !== '/404.html' && (
      <script
        is:inline
        type="application/ld+json"
        set:html={JSON.stringify({
          '@context': 'https://schema.org',
          '@type': 'Person',
          '@id': `${Astro.site}#person`,
          identifier: 'ratko-simidzija',
          name: 'Ratko Simidzija',
          givenName: 'Ratko',
          familyName: 'Simidzija',
          email: 'comm.sr@tuta.com',
          jobTitle: 'JavaScript Developer',
          description:
            'JavaScript Developer specializing in React, TypeScript, and modern web development. Five years of experience building e-commerce platforms, trading applications, and web solutions.',
          worksFor: {
            '@type': 'Organization',
            name: 'ePages',
          },
          address: {
            '@type': 'PostalAddress',
            addressLocality: 'Limassol',
            addressCountry: 'CY',
          },
          hasOccupation: {
            '@type': 'Occupation',
            name: 'JavaScript Developer',
            occupationalCategory: '15-1252.00',
          },
          knowsAbout: [
            'React',
            'Remix',
            'TypeScript',
            'Redux',
            'Angular',
            'Svelte',
            'Astro',
            'Node.js',
            'Jest',
            'Cypress',
            'Playwright',
            'JavaScript',
            'HTML',
            'CSS',
            'Webpack',
            'Git',
            'Web Accessibility',
            'Responsive Design',
            'E2E Testing',
          ],
          alumniOf: [
            {
              '@type': 'EducationalOrganization',
              name: 'DCI Digital Career Institute',
            },
            {
              '@type': 'EducationalOrganization',
              name: 'MBS Business School',
            },
          ],
          url: Astro.site?.toString(),
          sameAs: [
            'https://github.com/sixra',
            'https://www.linkedin.com/in/ratkosimidzija',
            'https://x.com/sixra01',
          ],
          mainEntityOfPage: {
            '@type': 'WebPage',
            '@id': Astro.site?.toString(),
          },
        })}
      />
    )
}

<!-- Page Initialization Scripts -->
<script>
  function initPage() {
    const headings = document.querySelectorAll('h2[id]');
    headings.forEach((heading) => {
      heading.setAttribute('tabindex', '0');
      heading.setAttribute('role', 'button');
      heading.setAttribute('aria-label', `Copy link to ${heading.textContent}`);

      const handleCopy = () => {
        const id = heading.getAttribute('id');
        if (id) {
          const url = `${window.location.origin}${window.location.pathname}#${id}`;
          window.history.pushState({}, '', `#${id}`);

          navigator.clipboard
            .writeText(url)
            .then(() => showToast('Link copied to clipboard!'))
            .catch((err: unknown) => {
              console.error('Failed to copy link:', err);
              showToast('Failed to copy link', true);
            });
        }
      };

      heading.addEventListener('click', handleCopy);
      heading.addEventListener('keydown', (e) => {
        const keyEvent = e as KeyboardEvent;
        if (keyEvent.key === 'Enter' || keyEvent.key === ' ') {
          keyEvent.preventDefault();
          handleCopy();
        }
      });
    });
  }

  function showToast(message: string, isError = false) {
    const toast = document.getElementById('globalCopyToast');
    if (toast) {
      toast.textContent = message;
      toast.classList.toggle('error', isError);
      toast.classList.add('show');
      setTimeout(() => toast.classList.remove('show'), 2000);
    }
  }

  // Run on initial load and after each view transition
  initPage();
  document.addEventListener('astro:after-swap', initPage);

  // Scroll to top on navigation
  document.addEventListener('astro:after-swap', () => {
    window.scrollTo({ top: 0, behavior: 'instant' });
  });

  // Blog title transitions
  function setupBlogTitleTransitions() {
    document.querySelectorAll('[data-blog-title]').forEach((title) => {
      const link = title.closest('a');
      if (link) {
        link.addEventListener('click', () => {
          const slug = title.getAttribute('data-slug');
          if (slug) {
            (title as HTMLElement).style.viewTransitionName = `post-title-${slug}`;
          }
        });
      }
    });
  }

  setupBlogTitleTransitions();
  document.addEventListener('astro:after-swap', setupBlogTitleTransitions);

  // Enhanced focus management for screen readers
  document.addEventListener('astro:after-swap', () => {
    const title = document.querySelector('h1');
    if (title && title instanceof HTMLElement) {
      title.focus({ preventScroll: true });
    }
  });
</script>

<!-- Service Worker Registration (production only) -->
{
  import.meta.env.PROD && Astro.url.pathname !== '/404/' && (
    <script is:inline>
      if ('serviceWorker' in navigator) navigator.serviceWorker.register('/sw.js').catch(function
      (err) {console.error('SW registration failed:', err)})
    </script>
  )
}

<!-- Plausible Analytics (production only, privacy-respecting) -->
{
  import.meta.env.PROD && Astro.url.pathname !== '/404/' && (
    <script is:inline defer data-domain="sixra.github.io" src="https://plausible.io/js/script.js" />
  )
}
